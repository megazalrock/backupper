# AI修正後に手動修正が必要になった原因分析

## 概要

2026年1月5日、AIによる修正（コミット `58a3596b5` まで）の後、7件のコミットで手動修正が必要になった。本ドキュメントでは、その原因を分析し、今後AIへの指示を改善するための知見をまとめる。

## 手動修正の一覧

| コミット | 内容 | 問題のカテゴリ |
|----------|------|----------------|
| c1a02017d | fix: 年がついていなかった部分を修正 | 仕様理解不足 |
| 0744ae80d | fix: 案件からだと日付が表示されないバグを修正 | テスト不足 |
| ee191488c | refactor: リファクタ | コードスタイル |
| 43006a8d6 | refactor: 日付フォーマット定数をconstantsに移動 | リファクタ範囲 |
| f487144c5 | refactor: 日付フォーマット定数を整理しコメントを修正 | ドキュメント |
| ab72ed238 | test: スケジュール削除モーダルのテストケースを修正 | テスト更新漏れ |
| 520b53e4c | test: 使用されていないテストヘルパー関数を削除 | YAGNI違反 |

## 詳細分析

### 1. 仕様理解不足：年表示の欠落

**問題**
- AIは `PADDED_SHORT_DATE_FORMAT`（`MM月dd日`）を使用した
- 実際には年を含む `PADDED_LONG_DATE_FORMAT`（`yyyy年MM月dd日`）が必要だった

**手動修正内容**
```diff
- return fastFormatDate(props.fromDate, PADDED_SHORT_DATE_FORMAT)
+ return fastFormatDate(props.fromDate, PADDED_LONG_DATE_FORMAT)
```

**AIへの指示改善案**
> 日付フォーマットを変更する際は、既存のUIで年が表示されているかを確認し、ユーザーが日付を識別できるよう年の表示を維持してください。削除モーダルでは「いつのスケジュールか」を明確に識別する必要があるため、年を含むフォーマットを使用してください。

### 2. テスト不足：異なるコンテキストでの動作確認漏れ

**問題**
- スケジュール詳細モーダルを「案件から開く場合」と「スケジュール一覧から開く場合」で挙動が異なる
- `selectedScheduleDate` が null になるパターンのテストが不足していた

**手動修正内容**
```typescript
// フォールバックロジックの追加
:selected-schedule-date="selectedScheduleDate ?? selectedSchedule?.parsedDateTime.startDate ?? null"
```

**AIへの指示改善案**
> モーダルを開く導線が複数存在する場合（例：スケジュール一覧から、案件詳細から）、すべての導線での動作確認をお願いします。特に、propsがnullになる可能性があるケースを考慮してください。

### 3. コードスタイルの不一致

**問題**
- AIは三項演算子を使った簡潔な書き方を選択
- プロジェクトでは可読性を重視し、if文＋コメントでの記述を好む傾向

**AIの実装**
```typescript
const editSingleLabel = computed(() =>
  Type.isNull(formattedSelectedDate.value)
    ? 'この予定のみ編集'
    : `${formattedSelectedDate.value}のみ編集`,
)
```

**手動修正後**
```typescript
const editSingleLabel = computed(() => {
  // モーダルを閉じる瞬間などprops.selectedScheduleDateがnullになるタイミングが存在するので
  // 念の為フォールバックを残している
  if (Type.isNull(formattedSelectedDate.value)) {
    return 'この予定のみ編集'
  }
  return `${formattedSelectedDate.value}のみ編集`
})
```

**AIへの指示改善案**
> フォールバックロジックには「なぜフォールバックが必要なのか」をコメントで説明してください。三項演算子より、if文で条件を明示し、意図がわかるコメントを付ける形式を優先してください。

### 4. リファクタリング範囲の判断ミス

**問題**
- AIは `PADDED_SHORT_DATE_FORMAT` のみを `constants/` に移動
- 実際には関連する定数群（`DATE_FORMAT`, `SHORT_DATE_FORMAT`, `TIME_FORMAT`, `ALL_DAY_STRING`）も一緒に移動すべきだった

**AIへの指示改善案**
> 定数をconstantsに移動する際は、関連する定数もまとめて移動してください。同じファイルで定義されている定数は、セットで移動する方が一貫性が保たれます。

### 5. テスト更新の漏れ

**問題**
- 日付フォーマットを変更したにもかかわらず、テストケースの期待値が更新されなかった

**手動修正内容**
```diff
- expect(textElement.text().replace(/\s/g, '')).toContain('01月15日のスケジュールを削除します。')
+ expect(textElement.text().replace(/\s/g, '')).toContain('2025年01月15日のスケジュールを削除します。')
```

**AIへの指示改善案**
> フォーマットや表示内容を変更した場合は、必ず関連するテストを実行し、期待値の更新も行ってください。`docker compose exec -T front pnpm vitest` でテストを実行して、失敗がないことを確認してください。

### 6. YAGNI違反：未使用コードの追加

**問題**
- AIが「将来使用予定」として `@ts-expect-error` 付きの未使用関数を追加した

**削除されたコード**
```typescript
// @ts-expect-error -- 将来の使用のために定義。既存のテストは段階的に移行予定
const findListItemByText = (textContent: string): HTMLElement => {
  // ...
}
```

**AIへの指示改善案**
> 「将来使うかもしれない」という理由でのコード追加は避けてください。必要になった時点で実装してください。未使用のコードはレビューで指摘される可能性が高く、削除対象になります。

### 7. スコープ外の変更（リバートが必要になった）

**問題**
- テストファイルに対して、本来の修正範囲外の変更が含まれていた
  - トレイリングカンマの削除
  - eslint-disableコメントの追加/削除
  - import文の並び替え
  - 新規テストケースの追加（`PADDED_SHORT_DATE_FORMAT`のテスト）

**AIへの指示改善案**
> 修正は指示された範囲に限定してください。以下は避けてください：
> - フォーマッターによる自動整形（トレイリングカンマ、空行など）
> - eslintコメントの追加・削除
> - import文の並び替え
> - 「ついでに」の追加機能やテスト
>
> 関係ない部分を変更するとレビューの負担が増え、リバートが必要になる可能性があります。

## 改善のための総合的な指示テンプレート

今後、同様のタスクを依頼する際は、以下の点を明示的に指示する：

```markdown
## タスク内容
[具体的な変更内容]

## 確認事項
- [ ] 複数の導線（一覧から、詳細から等）での動作確認
- [ ] 関連するテストの実行と期待値の更新
- [ ] nullやundefinedになるケースの考慮

## 制約
- 修正は指示された範囲のみに限定する
- フォーマット変更やimport整理は含めない
- 「将来のため」の未使用コードは追加しない
- フォールバックには理由をコメントで説明する

## コードスタイル
- 三項演算子より if 文 + コメントを優先
- 関連する定数は一緒に移動する
```

## まとめ

手動修正が必要になった主な原因：

1. **仕様の暗黙知**: 年表示の必要性など、明示されていない要件
2. **テスト範囲の不足**: 異なる導線での動作確認漏れ
3. **スタイルの不一致**: プロジェクト固有のコードスタイル
4. **スコープの逸脱**: 「ついでに」の変更によるノイズ
5. **YAGNI違反**: 未使用コードの追加

これらを事前に指示に含めることで、手動修正の必要性を減らすことができる。
